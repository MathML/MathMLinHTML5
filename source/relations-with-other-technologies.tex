\section{Relation with other technologies}

\subsection{HTML5 Tree}

\subsubsection{DOM, HTML, SVG and Javascript}

User agents must use a HTML5 \cite{HTML5} parser to build a DOM tree
\cite{DOM1} from the source code of web pages. In particular, they must follow
the rules describing when elements must be in the MathML namespace
{\tt http://www.w3.org/1998/Math/MathML} and must
recognize the entity definitions from the HTML MathML entity set of
\cite{XMLEntities}. They must also take into account the following integration
points between SVG, MathML and HTML as allowed by \cite{ValidatorSchemas}:

\begin{enumerate}
\item The {\tt <math>} element can be used at any position permitted for
  phrasing content or inside SVG {\tt <foreignObject>} elements.
\item The {\tt <svg>} element can be used inside {\tt <annotation-xml>}
  elements with encoding {\tt SVG1.1} or {\tt image/svg+xml}.
\item The {\tt <html>} element and flow content can be used inside
  {\tt <annotation-xml>} elements with encoding {\tt application/xhtml+xml}
  or {\tt text/html}.
\item Any phrasing element can be used inside {\tt <mtext>} elements.
\end{enumerate}

From this DOM tree, user agents must provide a visual representation of the
document. The DOM tree may be dynamically modified using Javascript
\cite{ECMA262} and the user agents must keep the visual representation in
synchronization with the DOM tree.

When evaluating the SVG {\tt requiredExtensions} attribute \cite{SVG11},
user agents must claim support for the extension of name
{\tt http://www.w3.org/1998/Math/MathML}.
An algorithm to decide the visible child of the {\tt <semantics>} element is
proposed in section \ref{semantics}.

\subsubsection{MathML}

All MathML elements accept the {\tt id}, {\tt class} and {\tt style} attributes
\cite{MathML3}. They must be interpreted as described in section 3.2.5 of the
HTML5 specification \cite{HTML5} and in particular they specify a unique
identifier (to identify elements in links and scripting), affect
CSS selectors and {\tt getElementsByClassName()} and enable authors to do
inline styling.

MathML 3 allows to use the {\tt href} attribute on any MathML element
\cite{MathML3}. In the present specification, it is only required to implement
{\tt href} on the {\tt mrow} element with the behavior described in 4.8
of the HTML5 specification for the {\tt a} element \cite{HTML5}. It is
recommended to make links visually distinguisable by default, for example by
adding a rule in the User Agent Stylesheet (section \ref{UAStylesheet}) such as
\begin{lstlisting}
mrow[href] {
  color: blue;
}
\end{lstlisting}

The toplevel {\tt math} element accepts the {\tt altimg}, {\tt altimg-width},
{\tt altimg-height}, {\tt altimg-valign} and {\tt alttext} attributes.
These attributes allow to specify fallback content and may just be ignored.
User agents that do not fully implement this specification may decide to
render this fallback content in some situation e.g. when they are specified or
under a preference option. In that case, an approximate implementation is to
render the {\tt math} element as a HTML {\tt img} element with the
value of {\tt altimg} as an {\tt src} attribute, the value of
{\tt alt} as a {\tt alttext} attribute, the value of {\tt altimg-width} as
the CSS {\tt width} property, the value of {\tt altimg-height} as
the CSS {\tt height} property and the value of {\tt altimg-valign} as
the CSS {\tt vertical-align} property \cite{HTML5} \cite{CSS2}. Here is a
partial implementation using the {\tt attr()} function of \cite{CSS3Values}:
%
\begin{lstlisting}
math {
  display: inline;
}
math[display="block"] {
  display: block;
  text-align: center;
}
math {
  background-image: attr(altimg url);
  width: attr(altimg-width length);
  height: attr(altimg-height length);
  vertical-align: attr(altimg-valign length);
}
math > * {
  display: none;
}
\end{lstlisting}

The toplevel {\tt math} element also accepts the {\tt display} attribute,
{\tt mathcolor}, {\tt mathbackground} attributes as well as other attributes
from the {\tt mstyle} element. These attributes must be supported and this
can be achieved using specific rules in the User Agent Stylesheet
as described in section \ref{UAStylesheet}.

In general MathML elements or attributes that are not mentioned in this
specification may just be ignored. This includes deprecated attributes or
Content Markup descripted in chapter 4 of the MathML 3 specification
\cite{MathML3}.

\subsection{Text and Math layout}

\subsubsection{Open Font Format}

Because math fonts generally contain very tall glyphs such as big integrals,
using typographic metrics is important to avoid excessive line spacing. This
behavior is specified in math fonts using the USE\_TYPO\_METRICS flag from the
OS/2 table \cite{OpenFontFormat3} and user agents must honor that flag.

Mathematical formulas can be viewed as an extension of standard text layout
and so user agents must already support the latter. They must be able to perfom
complex text layout \cite{CTL} using fonts under the Open Font Format
\cite{OpenFontFormat3}. In particular, they must implement bidirectional
rendering and shaping of Arabic scripts.

Mathematical formulas may mix standard text with other graphical outlines
(e.g. fraction or top radical bars). For consistency, these outlines should
be rendered the same way as normal text. In particular, user agents must be
able to apply {\tt visibility} and {\tt color} CSS properties to them. They may
also support similar CSS properties for text such as like {\tt text-shadow} or
{\tt opacity}.

Good mathematical rendering requires use of non-Unicode glyphs. Mathematical
fonts may only provide these glyphs when the {\tt math\lxAddClass{MATH}}
script tag is enabled and so user agents must ensure that the text within
MathML token
elements is rendered with that script tag. They must also support glyph
selections via the OpenType font features
{\tt ssty\lxAddClass{MATH}} (Script Style), {\tt flac\lxAddClass{MATH}}
(Flattened Accents over Capitals), {\tt dtls\lxAddClass{MATH}} (Dotless Forms)
and {\tt rtlm} (Right-to-left mirrored forms) \cite{OpenFontFormat3}.
At the time of writing, Unicode does not distinguish betwen Chancery and
Spencerian style for the Unicode MATHEMATICAL SCRIPT characters. Some
mathematical fonts rely on {\tt salt} or {\tt ssXY} properties to provide
both styles. User agents may support the CSS {\tt font-variant-alternates}
property and corresponding OpenType font features to enable page authors
to get access to these styles \cite{CSS3Font} \cite{OpenFontFormat3}.

User agents must be able to read information from the
OpenType MATH table \cite{OpenFontFormat3}.
In particular they must be able to read the values from the
{\tt MathConstants\lxAddClass{MATH}} table.
They must also be able to use the {\tt MathVariants\lxAddClass{MATH}} subtable
to solve the following problem: given a particular default glyph shape and a
certain width or height, find a variant shape glyph (or a construct created by
putting several glyphs together) that has the required measurement.
For more details, see section \ref{Operators}.

\subsubsection{LaTeX}\label{LaTeX}

Mathematical rendering rules in this specification are implicitly based on
MathML, OpenType MATH table and the TeXBook
\cite{MathML3} \cite{OpenFontFormat3} \cite{TeXBook}. In this section, we
describe more precisely some rules from the TeXBook.

In addition to MathML's {\tt displaystyle} and {\tt scriptlevel}, LaTeX has
a ``cramped'' property, which is involved in the determination of script shifts.
It is initially unset on the {\tt math} element and in general
all the children inherits the ``cramped'' property from their parent.
However, it is set to true in the following children:

\begin{enumerate}
\item The denominator of an {\tt mfrac} element. See section \ref{Fractions}.
\item The subscripts of the {\tt msub}, {\tt msubsup},
  {\tt munder} and {\tt munderover} elements.
  See section \ref{ScriptAndLimitSchemata}.
\item The overscript of the
  {\tt mover} and {\tt munderover} elements when it is an {\tt accent} per
  the MathML specification. See section \ref{ScriptAndLimitSchemata}.
\item The children of the {\tt msqrt} and {\tt mroot}
  elements as well as the {\tt menclose} element that have {\tt radical}
  notation.
\end{enumerate}

To implement math spacing, the TeXBook defines eight basic types
({\tt Ord} for ordinary atoms, {\tt Op} for large operators,
{\tt Bin} for binary operations, {\tt Rel} for relations,
{\tt Open} for opening fences, {\tt Close} for closing fences,
{\tt Punct} for punctuations and {\tt Inner} for a delimited subformula) and
define an inter space for each pair of such types. In the present specification,
we only follow the spacing algorithm of MathML 3: by default the inter space
is always zero and the spacing is produced by spacing elements like
{\tt mspace}, {\tt mphantom} or {\tt mpadded} or by the leading and trailing
space around embellished operators.

\subsection{CSS Styling}

\subsubsection{Properties}

User agents must support the CSS language \cite{CSS2} and take special styling
into account when building the visual representation of the document.
We assume that at least the following properties are supported:
%
\begin{enumerate}
\item {\tt display}: at least inline, block, inline-table, table-row,
  table-cell and none.
\item {\tt direction}
\item {\tt font} property and its shorthands.
\item {\tt background} and {\tt color}
\item {\tt visibility}
\end{enumerate}

In addition, this specification introduces new CSS properties that must be
supported by user agents unless they are able to reproduce equivalent rendering
behavior described in the present specification:

\begin{itemize}

\item \begin{tabular}{ll}\label{CSSScriptMathStyle}
  \emph{Name:} & {\tt 'mathml-math-style'} \\
  \emph{Value:} & display | inline \\
  \emph{Initial:} & inline \\
  \emph{Applies to:} & All elements \\
  \emph{Inherited:} & yes \\
  \emph{Percentages:} & N/A \\
  \emph{Media:} & visual \\
  \emph{Computed value:} & as specified \\
  \emph{Animatable:} & no \\
  \emph{Description:} & ...
\end{tabular}

\item \begin{tabular}{ll}\label{CSSScriptMathVariant}
  \emph{Name:} & {\tt 'mathml-math-variant'} \\
  \emph{Value:} & {\tt "none" | "normal" | "bold" | "italic" | "bold-italic" |
  "double-struck" | "bold-fraktur" | "script" | "bold-script" | "fraktur" |
  "sans-serif" | "bold-sans-serif" | "sans-serif-italic" |
  "sans-serif-bold-italic" | "monospace" | "initial" | "tailed" | "looped" |
  "stretched"} \\
  \emph{Initial:} & none \\
  \emph{Applies to:} & All elements \\
  \emph{Inherited:} & yes \\
  \emph{Percentages:} & N/A \\
  \emph{Media:} & visual \\
  \emph{Computed value:} & as specified \\
  \emph{Animatable:} & no \\
  \emph{Description:} & ...
\end{tabular}

\item \begin{tabular}{ll}\label{CSSScriptLevel}
  \emph{Name:} & {\tt 'mathml-script-level'} \\
  \emph{Value:} & {\tt \textless integer\textgreater |
  increment | increment-twice | increment-if-inline} \\
  \emph{Initial:} & 0 \\
  \emph{Applies to:} & All elements \\
  \emph{Inherited:} & yes \\
  \emph{Percentages:} & N/A \\
  \emph{Media:} & visual \\
  \emph{Computed value:} & as specified \\
  \emph{Animatable:} & no \\
  \emph{Description:} & ...
\end{tabular}

\item \begin{tabular}{ll}\label{CSSScriptSizeMultiplier}
  \emph{Name:} & {\tt 'mathml-script-size-multiplier'} \\
  \emph{Value:} & \textless number\textgreater \\
  \emph{Initial:} & 0 \\
  \emph{Applies to:} & All elements \\
  \emph{Inherited:} & yes \\
  \emph{Percentages:} & N/A \\
  \emph{Media:} & visual \\
  \emph{Computed value:} & as specified \\
  \emph{Animatable:} & no \\
  \emph{Description:} & ...
\end{tabular}

\item \begin{tabular}{ll}\label{CSSScriptSizeMinSize}
  \emph{Name:} & {\tt 'mathml-script-min-size'} \\
  \emph{Value:} & \textless number\textgreater \\
  \emph{Initial:} & 0 \\
  \emph{Applies to:} & All elements \\
  \emph{Inherited:} & yes \\
  \emph{Percentages:} & N/A \\
  \emph{Media:} & visual \\
  \emph{Computed value:} & as specified \\
  \emph{Animatable:} & no \\
  \emph{Description:} & ...
\end{tabular}

\end{itemize}

Add reference / explanation about these new properties \lxAddClass{issue}

The following MathML attributes must be mapped to CSS properties:
%
\begin{enumerate}
\item The {\tt mathcolor} and {\tt mathbackground} attributes on presentation
  MathML elements are mapped to {\tt color} and {\tt background} respectively.
\item The {\tt mathsize}, {\tt mathvariant} attributes on the {\tt math},
  {\tt mstyle} and token elements are mapped to {\tt font-size} and
  {\tt mathml-math-variant} respectively.
\item The {\tt dir} attribute on the {\tt math}, {\tt mstyle}, {\tt mrow} and
  {\tt token} elements are mapped to {\tt direction}.
\item The {\tt scriptlevel}, {\tt scriptminsize} and {\tt scriptsizemultiplier}
  attributes on the {\tt math} and {\tt mstyle} elements are mapped to
  {\tt mathml-script-level}, {\tt mathml-script-size-multiplier}
  and {\tt mathml-script-min-size} respectively.
\end{enumerate}

Many of the MathML elements accept attributes with length value whose
general syntax is described in section 2.1.5.2 of the MathML specification
\cite{MathML3}. In general,
the syntax is compatible with \cite{CSS2} but User Agents must handle
specificities of the MathML specification. In particular, the keywords
{\tt veryverythinmathspace},
{\tt verythinmathspace},
{\tt thinmathspace},
{\tt mediummathspace},
{\tt thickmathspace},
{\tt verythickmathspace},
{\tt veryverythickmathspace},
{\tt negativeveryverythinmathspace},
{\tt negativeverythinmathspace},
{\tt negativethinmathspace},
{\tt negativemediummathspace},
{\tt negativethickmathspace},
{\tt negativeverythickmathspace} and
{\tt negativeveryverythickmathspace} keywords must be interpreted as their
equivalent {\tt em} value. Also, percent and unitless values must be interpreted
with respect to the appropriate reference value. Note that the {\tt mpadded}
element also accepts more general length values as discussed in section
\ref{mpadded}.

\subsubsection{User Agent Stylesheet for MathML}\label{UAStylesheet}

Because mathematical formulas are generally written with special fonts, the
default user agent stylesheet must reset the CSS {\tt font-family} on the
{\tt math} element to {\tt serif}. User agents should then use their own
mechanism to try and interpret this {\tt serif} value on the {\tt math} element
as a font with an OpenType MATH table.

Below is an example on a stylesheet to style MathML elements on which the
User Agents may rely. Unfortunately, some rendering engines do not allow
universal selectors in their user agent stylesheets and so rules must be
expanded to list all possible MathML elements described in the present
specification. For example {\tt mfrac > *} can be converted into
{\tt mfrac > mi, mfrac > mn, mfrac > mo, mfrac > mtext, mfrac > mspace,
mfrac > ms, mfrac > mrow, mfrac > mfrac, mfrac > msqrt, mfrac > mroot,
mfrac > mstyle, mfrac > merror, mfrac > mpadded, mfrac > mphantom,
mfrac > menclose, mfrac > msub, mfrac > msubsup, mfrac > munder, mfrac > mover,
mfrac > munderover, mfrac > mmultiscripts, mfrac > mtable, mfrac > maction}.

\begin{lstlisting}
@namespace url(http://www.w3.org/1998/Math/MathML);

/* The <math> element */
math {
  direction: ltr;
  display: inline;
  font-size: inherit;
  font-style: normal;
  font-family: serif;
  mathml-math-style: inline;
}
math[display="block"] {
  display: block;
  text-align: center;
  mathml-math-style: display;
}
math[display="inline"] {
  display: inline;
  mathml-math-style: inline;
}
math[displaystyle="false"] {
  mathml-math-style: inline;
}
math[displaystyle="true"] {
  mathml-math-style: display;
}

/* Links */
mrow[href] {
  color: blue;
}

/* Tabular elements */
mtable {
  display: inline-table;
  mathml-math-style: inline;
}
mtable[displaystyle="true"] {
  mathml-math-style: display;
}
mtable[frame="none"] {
  border: none;
}
mtable[frame="solid"] {
  border: solid thin;
}
mtable[frame="dashed"] {
  border: dashed thin;
}
mtr, mlabeledtr {
  display: table-row;
  vertical-align: baseline;
}
mlabeledtr > mtd:first-child {
  display: none;
}
mtd {
  display: table-cell;
  vertical-align: inherit;
  text-align: center;
  padding: 0.5ex 0.4em;
}

/* The <ms> element */
ms {
  display: inline;
}
ms:before, ms:after {
  content: "\0022"
}
ms[lquote]:before {
  content: attr(lquote)
}
ms[rquote]:after {
  content: attr(rquote)
}

/*  The <merror> element */
merror {
 outline: solid thin red;
 background-color: lightYellow;
}

/* The <mphantom> element */
mphantom {
  visibility: hidden;
}

/* Scriptlevel and displaystyle for other elements */
mstyle[displaystyle="false"] {
  mathml-math-style: inline;
}
mstyle[displaystyle="true"] {
  mathml-math-style: display;
}
mfrac > * {
  mathml-script-level: increment-if-inline;
  mathml-math-style: inline;
}
mroot > :not(:first-child) {
  mathml-script-level: increment-twice;
  mathml-math-style: inline;
}
msub > :not(:first-child),
msup > :not(:first-child),
msubsup > :not(:first-child),
mmultiscripts > :not(:first-child) {
  mathml-script-level: increment;
  mathml-math-style: inline;
}
munder > :not(:first-child),
mover > :not(:first-child),
munderover > :not(:first-child) {
  mathml-math-style: inline;
}
\end{lstlisting}
